name: Publish Homebrew

on:
  release:
    types: [published]

defaults:
  run:
    shell: bash

permissions:
  contents: read

jobs:
  meta:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Get Version
        id: version
        run: |
          CARGO_VERSION=$(yq -oy ".package.version" maa-cli/Cargo.toml)
          # check if version is equal to tag if not PR
          if [ "$GITHUB_EVENT_NAME" != "pull_request" ]; then
            REF=${{ github.ref }}
            REF_VERSION=${REF#refs/tags/v}
            if [ "$REF_VERSION" != "$CARGO_VERSION" ]; then
              echo "Version mismatch: $REF_VERSION != $CARGO_VERSION"
            fi
          fi
          echo "Version: $CARGO_VERSION"
          echo "version=$CARGO_VERSION" >> $GITHUB_OUTPUT

  bump-cask:
    name: Bump Cask and Open PR
    runs-on: macos-latest
    needs: [meta]
    steps:
      - name: Update Homebrew Cask
        uses: wangl-cc/action-homebrew-bump-cask@master
        with:
          token: ${{secrets.MAA_HOMEBREW_BUMP_PR}}
          tap: MaaAssistantArknights/homebrew-tap
          cask: maa-cli-bin
          tag: v${{ needs.meta.outputs.version }}
          no_fork: true
          force: false

  bump-formula:
    name: Bump Formula and Open PR
    runs-on: macos-latest
    needs: [meta]
    steps:
      - name: Update Homebrew Formula
        uses: dawidd6/action-homebrew-bump-formula@v3
        with:
          token: ${{secrets.MAA_HOMEBREW_BUMP_PR}}
          tap: MaaAssistantArknights/homebrew-tap
          formula: maa-cli
          tag: v${{ needs.meta.outputs.version }}
          no_fork: true
          force: false
